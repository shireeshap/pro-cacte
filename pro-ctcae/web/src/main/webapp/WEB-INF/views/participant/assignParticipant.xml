<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="
		http://www.springframework.org/schema/webflow
		http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">


    <var name="command" class="gov.nih.nci.cabig.caaers.web.participant.StudySubjectAssignmentCommand"></var>

    <var name="studySite" class="gov.nih.nci.cabig.caaers.domain.StudySite"></var>
    <var name="studyParticipantPriorTherapy" class="gov.nih.nci.cabig.caaers.domain.StudyParticipantPriorTherapy"></var>

    <view-state id="assignParticipant" view="participant/assignParticipant"></view-state>


    <view-state id="assignStudy" view="par/assignStudy">
        <transition on="chooseStudy" to="chooseStudy">
        </transition>

        <transition on="chooseParticipant" to="chooseParticipant">
        </transition>

        <transition on="medicalHistory" to="medicalHistory">
        </transition>

        <transition on="save" to="finalSave">

        </transition>
    </view-state>


    <view-state id="medicalHistory" view="par/medicalHistory" model="command">
        <transition on="addPriorTherapy" to="addPriorTherapy">
            <evaluate expression="command.newPriorTherapy()" result="studyParticipantPriorTherapy"></evaluate>
        </transition>

        <transition on="confirm" to="assignStudy"/>

        <transition on="cancel" to="assignStudy" bind="false"/>

        <transition on="done" to="assignStudy" bind="false"/>


    </view-state>


    <view-state id="addPriorTherapy" view="par/addPriorTherapy" model="studyParticipantPriorTherapy" popup="true">
        <on-entry>
            <evaluate expression="priorTherapyFieldGroup.referenceData(studyParticipantPriorTherapy)"
                      result="flowScope.fieldGroups"
                      result-type="java.util.Map"></evaluate>

        </on-entry>
        <transition on="addAgent">

            <evaluate expression="studyParticipantPriorTherapy.getPriorTherapyAgents().size()" result="flashScope.index"
                      result-type="java.lang.Integer"></evaluate>
            <evaluate expression="studyParticipantPriorTherapy.newPriorTherapyAgent()"></evaluate>
            <render fragments="agentDetails"></render>
        </transition>

        <transition on="save" to="medicalHistory">
            <evaluate expression="command.addPriorTherapy(studyParticipantPriorTherapy,messageContext)"></evaluate>
            <render fragments="priorTherapyDetails"></render>
        </transition>


        <transition on="cancel" to="medicalHistory" bind="false">
            <render fragments="priorTherapyDetails"></render>
        </transition>

    </view-state>


    <view-state id="chooseStudy" view="par/chooseStudy" model="command" popup="true">
        <transition on="search">
            <!--<evaluate expression="command.validate(messageContext)"></evaluate>-->

            <evaluate expression="studyRepository.search(command.studyType,command.studyText)"
                      result="viewScope.studies" result-type="java.util.List"></evaluate>

        </transition>

        <transition on="confirm" to="assignStudy">
            <evaluate expression="studySiteDao.findByStudyAndOrganization(command.studyId,command.siteId)"
                      result="studySite"
                      result-type="gov.nih.nci.cabig.caaers.domain.StudySite"></evaluate>

            <render fragments="studyDetails"></render>
        </transition>

        <transition on="cancel" to="assignStudy" bind="false">
        </transition>


    </view-state>


    <view-state id="chooseParticipant" view="par/chooseParticipant" model="command" >
        <transition on="search">


            <evaluate
                    expression="participantRepository.search(command.participantType,command.participantText,studySite)"
                    result="flowScope.participants" result-type="java.util.List"></evaluate>

        </transition>

        <transition on="confirm" to="assignStudy">
            <evaluate expression="participantDao.getById(command.participantId)"
                      result="flowScope.participant"
                      result-type="gov.nih.nci.cabig.caaers.domain.Participant"></evaluate>
        </transition>

        <transition on="cancel" to="assignStudy" bind="false">
        </transition>


    </view-state>

    <!--<view-state id="updateDetails" view="par/updateDetails" model="participant">-->
    <!--<on-entry>-->
    <!--<evaluate expression="createParticipantFieldGroup.referenceData(participant)"-->
    <!--result="flowScope.fieldGroups" result-type="java.util.Map"></evaluate>-->
    <!--</on-entry>-->
    <!--<transition on="save" to="finalSave">-->
    <!--<evaluate expression="participantDao.save(participant)"></evaluate>-->
    <!--<evaluate expression="participantValidator.validateBasicDetails(participant)"></evaluate>-->
    <!--</transition>-->
    <!--</view-state>-->


    <end-state id="finalSave" commit="true">
        <on-entry>
            <!--<evaluate expression="" result="assignment"-->
            <!--result-type="gov.nih.nci.cabig.caaers.domain.StudyParticipantAssignment"></evaluate>-->
            <evaluate
                    expression="studyParticipantAssignmentDao.save(command.createStudyParticipantAssignment(studySite,participant))"></evaluate>
        </on-entry>
    </end-state>


</flow>