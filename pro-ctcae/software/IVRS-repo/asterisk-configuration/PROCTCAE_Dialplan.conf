;!
;! Automatically generated configuration file
;! Filename: extensions.conf (/etc/asterisk/PROCTCAE_Dialplan.conf)
;! Generator: Manager
;! Creation Date: Mon Apr 25 09:58:58 2011
;!
[callout_en]
exten => 7039350104,1,Goto(s,1)
exten => 5712664016,1,Goto(s,1)

exten => s,1,Set(REPEAT=0)
exten => s,n,Set(LANGUAGE="proctcae/en/")
exten => s,n(playWelcomeMesasge),Background(${LANGUAGE}calloutMessage)
exten => s,n,WaitExten(5)

exten => 1,1,Playback(${LANGUAGE}welcome)
exten => 1,n,Goto(myTest,1,1)

exten => t,1,Set(REPEAT= $[${REPEAT} + 1])
;exten => t,n,Playback(${LANGUAGE}sorryCouldNotHear)
exten => t,n,Gotoif($[${REPEAT}<2]?s,playWelcomeMesasge:abort)
exten => t,n(abort),NoOp("No reponse from user")  ;
exten => t,n,Hangup()

exten => i,1,Playback(${LANGUAGE}invalidOption)
exten => i,n,Goto(s,playWelcomeMesasge)

[callout_es]
exten => 7039350104,1,Goto(s,1)
exten => 5712664016,1,Goto(s,1)

exten => s,1,Set(REPEAT=0)
exten => s,n,Set(LANGUAGE="proctcae/es/")
exten => s,n(playWelcomeMesasge),Background(${LANGUAGE}calloutMessage)
exten => s,n,WaitExten(5)

exten => 1,1,Playback(${LANGUAGE}welcome)
exten => 1,n,Goto(myTest,1,1)

exten => t,1,Set(REPEAT= $[${REPEAT} + 1])
;exten => t,n,Playback(${LANGUAGE}sorryCouldNotHear)
exten => t,n,Gotoif($[${REPEAT}<2]?s,playWelcomeMesasge:abort)
exten => t,n(abort),NoOp("No reponse from user")  ;
exten => t,n,Hangup()

exten => i,1,Playback(${LANGUAGE}invalidOption)
exten => i,n,Goto(s,playWelcomeMesasge)

[callin_en]
exten => 7039350104,1,Goto(1,1)
exten => 5712664016,1,Goto(1,1)

exten => 1,1,Set(LANGUAGE="proctcae/en/")
exten => 1,n,Playback(${LANGUAGE}welcome)
exten => 1,n,Background(${LANGUAGE}languageOption)
exten => 1,n,WaitExten(5)

exten => 2,1,Set(LANGUAGE="proctcae/es/")
exten => 2,n,Goto(myTest,1,1)

exten => i,n,Goto(myTest,1,1)

exten => t,1,Goto(myTest,1,1)

;[callin_es]
;exten => 7039350104,1,Set(LANGUAGE="proctcae/es/")

;exten => 1,1,Set(LANGUAGE="proctcae/sp/")
;exten => 1,n,Goto(myTest,1,1)

[myTest]
exten => 1,1,Answer()
;exten => 1,n,Playback(${LANGUAGE}welcome)
exten => 1,n,Set(TIMEOUT(digit)=10)  ; Set Digit Timeout to 10 seconds
exten => 1,n,Set(TIMEOUT(response)=10)  ; Set Response Timeout to 10 seconds
exten => 1,n,Set(AUTH_TRY_COUNT=0)
exten => 1,n,Set(TIMEOUT_IN_SEC=10)
exten => 1,n,Set(RECALL_PERIOD_MODULUS_VALUE=10)
exten => 1,n,Set(RECORDED_FILE_LOCATION=/var/lib/asterisk/sounds/newSOundFiles/)
exten => 1,n,Goto(getCallerId,1)

exten => getCallerId,1,Read(INPUT_CALLER_ID,${LANGUAGE}askCallerId,10,,3)  ;Read CallerId from Keypress event
exten => getCallerId,n,Gotoif($["${INPUT_CALLER_ID}" != ""]?getCallerPin,1)
exten => getCallerId,n(abort),NoOp("DB ABORT FUNCTION CALL")
exten => getCallerId,n,Goto(endCall,1)

exten => getCallerPin,1,Read(INPUT_CALLER_PIN,${LANGUAGE}askCallerPin,4,,3)  ;Read CallerPin from Keypress event
exten => getCallerPin,n,Gotoif($["${INPUT_CALLER_PIN}" != ""]?callerAuth,1)
exten => getCallerPin,n(abort),NoOp("DB ABORT FUNCTION CALL")
exten => getCallerPin,n,Goto(endCall,1)

exten => callerAuth,1,Set(USER_ID=$[${ODBC_LOGIN_AUTH(${INPUT_CALLER_ID,INPUT_CALLER_PIN})}])  ;Call to DB for Caller authentication
exten => callerAuth,n,Gotoif($["${USER_ID}" = ""]?ivrsException,1)
exten => callerAuth,n,Gotoif($[${USER_ID} = -1]?ivrsException,1)
exten => callerAuth,n,Gosubif($[${USER_ID}=0]?myTest,incorrectCredentials,1:getUserForms,1)  ;Check for a valid user

exten => isNewUser,1,Set(IS_NEW_USER=$[${ODBC_IS_NEW_USER(${USER_ID})}])  ;check the user if he is new or already used IVRS
exten => isNewUser,n,Gotoif($["${IS_NEW_USER}" = ""]?ivrsException,1)
exten => isNewUser,n,Gotoif($[${IS_NEW_USER} = -1]?ivrsException,1)
exten => isNewUser,n,Gotoif($[${IS_NEW_USER}=1]?playInstructions,1:playInstructionsOption,1)  ; if new user, directly play instructions

exten => playInstructions,1,Playback(${LANGUAGE}instructions)  ; play Instructions
exten => playInstructions,n,Gotoif($["${QUESTION_ID}" != ""]?getAnswer,1)
exten => playInstructions,n,Goto(getFormQues,1)  ; go to form fill control

exten => playInstructionsOption,1,Read(INSTRUCTIONS_FLAG,${LANGUAGE}playInstructionOption,1,,3)  ; ask if user wants to skip instructions message
exten => playInstructionsOption,n,Gotoif($["${INSTRUCTIONS_FLAG}"=""]?endCallOnNoAnswer,1)  ; If nothing enters after 3 times, end call
exten => playInstructionsOption,n,Gotoif($[${INSTRUCTIONS_FLAG}=1]?skip)  ; If 1, play instructions else skip instructions
exten => playInstructionsOption,n,Gotoif($['${INSTRUCTIONS_FLAG}'='*']?playInstructions,1:invalidOption,1)
exten => playInstructionsOption,n(skip),Goto(getFormQues,1)

exten => endCallOnNoAnswer,1,Playback(${LANGUAGE}sorryCouldNotHear)
exten => endCallOnNoAnswer,n,Playback(${LANGUAGE}tryLater)
exten => endCallOnNoAnswer,n,Goto(endCall,1)

exten => invalidOption,1,Playback(${LANGUAGE}invalidOption)  ; "That's not valid, try again"
exten => invalidOption,n,Goto(playInstructionsOption,1)

exten => getUserForms,1,Set(NUMBER_OF_FORMS=$[${ODBC_GET_NUMBER_OF_FORMS(${USER_ID})}])
exten => getUserForms,n,Gotoif($["${NUMBER_OF_FORMS}" = ""]?ivrsException,1)
exten => getUserForms,n,Gotoif($[${NUMBER_OF_FORMS} = -1]?ivrsException,1)
exten => getUserForms,n,Gosubif($[${NUMBER_OF_FORMS}>0]?isNewUser,1)
exten => getUserForms,n,Playback(${LANGUAGE}noFormsAvaliable)
exten => getUserForms,n,Goto(endCall,1)

exten => getFormQues,1,Set(FORM_ID=$[${ODBC_GET_FORM(${USER_ID,FORM_NUMBER})}])  ;Get the FormId from DB
exten => getFormQues,n,Gotoif($["${FORM_ID}" = ""]?ivrsException,1)
exten => getFormQues,n,Gotoif($[${FORM_ID} = -1]?ivrsException,1)
exten => getFormQues,n,Set(FORM_RECALL_PERIOD=$[${ODBC_GET_FORM_RECALL_PERIOD(${USER_ID,FORM_NUMBER})}])  ;Get the recall period for the form
exten => getFormQues,n,Gotoif($["${FORM_RECALL_PERIOD}" = ""]?ivrsException,1)
exten => getFormQues,n,Gotoif($[${FORM_RECALL_PERIOD} = -1]?ivrsException,1)
exten => getFormQues,n,set(CORE_SYMPTOM_FLAG=0)
exten => getFormQues,n,Set(FREQUENCY_FLAG=0)
exten => getFormQues,n,Set(INTERFERENCE_FLAG=0)
exten => getFormQues,n,Set(SEVERITY_FLAG=0)
exten => getFormQues,n,Set(QUESTION_COUNTER=0)
exten => getFormQues,n,Set(QUESTION_MANDATORY_TYPE=0)
exten => getFormQues,n,Goto(formNewOrPending,1)

;check if form is new or in  progress state, based on that play the respective message
exten => formNewOrPending,1,Set(FORM_NEW_OR_PENDING=$[${ODBC_IS_FORM_NEW_OR_PENDING(${USER_ID},${FORM_ID})}])
exten => formNewOrPending,n,Gotoif($["${FORM_NEW_OR_PENDING}" = ""]?ivrsException,1)
exten => formNewOrPending,n,Gotoif($[${FORM_NEW_OR_PENDING} = -1]?ivrsException,1)
exten => formNewOrPending,n,Gotoif($[${FORM_NEW_OR_PENDING} = -2]?ivrsException,1)
exten => formNewOrPending,n,Gotoif($[${FORM_NEW_OR_PENDING} = 0]?playNewSurveyMessage:playInProgressMessage)
exten => formNewOrPending,n(playNewSurveyMessage),Playback(${LANGUAGE}newSurveyMessage)
exten => formNewOrPending,n,Goto(calculateSurveyProcessingTime,1)
exten => formNewOrPending,n(playInProgressMessage),Playback(${LANGUAGE}inProgressSurveyMessage)
exten => formNewOrPending,n,Goto(calculateSurveyProcessingTime,1)

;get the total no. of unanswered question
;based on that play the respective audio file
;create a counter to keep track for decide when the form is half way done
exten => calculateSurveyProcessingTime,1,Set(FORM_HALF_COMPLETED=0)
exten => calculateSurveyProcessingTime,n,Set(NO_OF_UNANSWERED_SYMPTOMS=$[${ODBC_GET_NO_OF_UNANSWERED_SYMPTOMS(${USER_ID,FORM_ID})}])
exten => calculateSurveyProcessingTime,n,Gotoif($["${NO_OF_UNANSWERED_SYMPTOMS}" = ""]?ivrsException,1)
exten => calculateSurveyProcessingTime,n,Gotoif($[${NO_OF_UNANSWERED_SYMPTOMS} = -1]?ivrsException,1)
exten => calculateSurveyProcessingTime,n,Gotoif($[${NO_OF_UNANSWERED_SYMPTOMS} = -2]?ivrsException,1)
exten => calculateSurveyProcessingTime,n,Gotoif($[${NO_OF_UNANSWERED_SYMPTOMS} <= 20]?play10minMessage)
exten => calculateSurveyProcessingTime,n,Gotoif($[${NO_OF_UNANSWERED_SYMPTOMS} <= 50]?play20minMessage)
exten => calculateSurveyProcessingTime,n,Gotoif($[${NO_OF_UNANSWERED_SYMPTOMS} > 50]?play30minMessage)
exten => calculateSurveyProcessingTime,n(play10minMessage),Playback(${LANGUAGE}10minsClip)
exten => calculateSurveyProcessingTime,n,Gotoif($[${NO_OF_UNANSWERED_SYMPTOMS} < 10]?playMandatoryMessages,1)
exten => calculateSurveyProcessingTime,n,Set(FORM_HALF_COMPLETED=$[${NO_OF_UNANSWERED_SYMPTOMS}/2])
exten => calculateSurveyProcessingTime,n,Set(FORM_HALF_COMPLETED=$[FLOOR(${FORM_HALF_COMPLETED})])
exten => calculateSurveyProcessingTime,n,Goto(playMandatoryMessages,1)
exten => calculateSurveyProcessingTime,n(play20minMessage),Playback(${LANGUAGE}20minsClip)
exten => calculateSurveyProcessingTime,n,Set(FORM_HALF_COMPLETED=$[${NO_OF_UNANSWERED_SYMPTOMS}/2])
exten => calculateSurveyProcessingTime,n,Set(FORM_HALF_COMPLETED=$[FLOOR(${FORM_HALF_COMPLETED})])
exten => calculateSurveyProcessingTime,n,Goto(playMandatoryMessages,1)
exten => calculateSurveyProcessingTime,n(play30minMessage),Playback(${LANGUAGE}30minsClip)
exten => calculateSurveyProcessingTime,n,Set(FORM_HALF_COMPLETED=$[${NO_OF_UNANSWERED_SYMPTOMS}/2])
exten => calculateSurveyProcessingTime,n,Set(FORM_HALF_COMPLETED=$[FLOOR(${FORM_HALF_COMPLETED})])
exten => calculateSurveyProcessingTime,n,Goto(playMandatoryMessages,1)

;play mandatory messages
exten => playMandatoryMessages,1,Playback(${LANGUAGE}mandatoryInstructions)
exten => playMandatoryMessages,n,Playback(${LANGUAGE}aboutToFillForm)
exten => playMandatoryMessages,n,Goto(getFirstQuestion,1)

exten => getFirstQuestion,1,Set(QUESTION_ID_TEXT=$[${ODBC_GET_FIRST_QUESTION(${USER_ID,FORM_ID})}])  ;Get the QuestionIdText from DB
exten => getFirstQuestion,n,Gotoif($["${QUESTION_ID_TEXT}" = ""]?ivrsException,1)
exten => getFirstQuestion,n,Gotoif($[${QUESTION_ID_TEXT} = -1]?ivrsException,1)
exten => getFirstQuestion,n,Set(QUESTION_ID=${CUT(QUESTION_ID_TEXT,_,1)})
exten => getFirstQuestion,n,Set(QUESTION_MANDATORY_TYPE_TEMP=${CUT(QUESTION_ID_TEXT,_,2)})
exten => getFirstQuestion,n,Set(QUESTION_MANDATORY_TYPE=${IF($[ "${QUESTION_MANDATORY_TYPE_TEMP}" != ""]?${QUESTION_MANDATORY_TYPE_TEMP}:${QUESTION_MANDATORY_TYPE})})
;Used to check if type of question is already answered
exten => getFirstQuestion,n,Goto(getAnswer,1)

exten => getAnswer,1,Gosubif($[${QUESTION_ID}=0]?afterLastQuestion,1)
exten => getAnswer,n,Set(QUESTION_TEXT=${ODBC_GET_QUESTION_TEXT(${USER_ID,FORM_ID,QUESTION_ID})})  ;Get the QuestionTect from DB
exten => getAnswer,n,Gotoif($["${QUESTION_TEXT}" = ""]?ivrsException,1)
exten => getAnswer,n,Gotoif($["${QUESTION_TEXT}" = "Data Not Found"]?ivrsException,1)
exten => getAnswer,n,Set(QUESTION_FILENAME=${ODBC_GET_QUESTION_FILENAME(${USER_ID,FORM_ID,QUESTION_ID})})  ;Get the QuestionFileName from DB
exten => getAnswer,n,Gotoif($["${QUESTION_FILENAME}" = ""]?ivrsException,1)
exten => getAnswer,n,Gotoif($["${QUESTION_FILENAME}" = "Data Not Found"]?ivrsException,1)
exten => getAnswer,n,Set(QUESTION_TYPE=${ODBC_GET_QUESTION_TYPE(${USER_ID,FORM_ID,QUESTION_ID})})  ;Get the QuestionType from DB
exten => getAnswer,n,Gotoif($["${QUESTION_TYPE}" = ""]?ivrsException,1)
exten => getAnswer,n,Gotoif($["${QUESTION_TYPE}" = "Data Not Found"]?ivrsException,1)
;check if the form is half way done
exten => getAnswer,n,Gosubif($[${FORM_HALF_COMPLETED}!=0]?playHalfWayDone,1)
;check the modulus of QUSETION_COUNTER, if it is modulo of 10 play the recall period
exten => getAnswer,n,Gosubif($[$[${QUESTION_COUNTER}%${RECALL_PERIOD_MODULUS_VALUE}] = 0]?playRecallPeriod,1)
exten => getAnswer,n,Set(QUESTION_COUNTER= $[${QUESTION_COUNTER} + 1])
exten => getAnswer,n,Gosubif($["${QUESTION_TYPE}"="PRESENT"]?PRESENTQUESTION,s,1)
exten => getAnswer,n,Gosubif($["${QUESTION_TYPE}"="FREQUENCY"]?FREQUENCYQUESTION,s,1)
exten => getAnswer,n,Gosubif($["${QUESTION_TYPE}"="SEVERITY"]?SEVERITYQUESTION,s,1)
exten => getAnswer,n,Gosubif($["${QUESTION_TYPE}"="INTERFERENCE"]?INTERFERENCEQUESTION,s,1)
exten => getAnswer,n,Gosubif($["${QUESTION_TYPE}"="AMOUNT"]?AMOUNTQUESTION,s,1)
exten => getAnswer,n,Goto(endCall,1)

exten => afterLastQuestion,1,Gosubif($[${CORE_SYMPTOM_FLAG}=1]?SUBMITFORM,s,1)
exten => afterLastQuestion,n,Gosubif($[${CORE_SYMPTOM_FLAG}=0]?CORE_SYMPTOM,s,1)

;check if the form is half way done; plyed only if
exten => playHalfWayDone,1,Set(NO_OF_UNANSWERED_SYMPTOMS=$[${ODBC_GET_NO_OF_UNANSWERED_SYMPTOMS(${USER_ID,FORM_ID})}])
exten => playHalfWayDone,n,Gotoif($["${NO_OF_UNANSWERED_SYMPTOMS}" = ""]?ivrsException,1)
exten => playHalfWayDone,n,Gotoif($[${NO_OF_UNANSWERED_SYMPTOMS} = -1]?ivrsException,1)
exten => playHalfWayDone,n,Gotoif($[${NO_OF_UNANSWERED_SYMPTOMS} = -2]?ivrsException,1)
exten => playHalfWayDone,n,Gosubif($[${NO_OF_UNANSWERED_SYMPTOMS}=${FORM_HALF_COMPLETED}]?playHalfWayDoneMessage)
exten => playHalfWayDone,n,Return
exten => playHalfWayDone,n(playHalfWayDoneMessage),Playback(${LANGUAGE}halfWayDoneMessage)
exten => playHalfWayDone,n,Return

exten => playRecallPeriod,1,Gotoif($[${FORM_RECALL_PERIOD} = 1]?sevenDays:monthly)
exten => playRecallPeriod,n(sevenDays),Playback(${LANGUAGE}7DaysRecallPeriod)
exten => playRecallPeriod,n,Return
exten => playRecallPeriod,n(monthly),Gotoif($[${FORM_RECALL_PERIOD} = 2]?playMonthly:lastTreatment)
exten => playRecallPeriod,n(playMonthly),Playback(${LANGUAGE}monthlyRecallPeriod)
exten => playRecallPeriod,n,Return
exten => playRecallPeriod,n(lastTreatment),Gotoif($[${FORM_RECALL_PERIOD} = 3]?playLastTreatment:noRecall)
exten => playRecallPeriod,n(playLastTreatment),Playback(${LANGUAGE}lastTreatmentRecallPeriod)
exten => playRecallPeriod,n(noRecall),Return

exten => getPreviousQuestion,1,Set(PREVIOUS_QUESTION_ID_TEXT=${ODBC_GET_PREVIOUS_QUESTION(${USER_ID,FORM_ID,QUESTION_ID,QUESTION_MANDATORY_TYPE})})
exten => getPreviousQuestion,n,Gotoif($["${PREVIOUS_QUESTION_ID_TEXT}" = ""]?ivrsException,1)
exten => getPreviousQuestion,n,Gotoif($[${PREVIOUS_QUESTION_ID_TEXT} = -1]?ivrsException,1)
exten => getPreviousQuestion,n,Set(PREVIOUS_QUESTION_ID=${CUT(PREVIOUS_QUESTION_ID_TEXT,_,1)})
exten => getPreviousQuestion,n,Set(PREVIOUS_QUESTION_MANDATORY_TYPE=${CUT(PREVIOUS_QUESTION_ID_TEXT,_,2)})
exten => getPreviousQuestion,n,Gotoif($[${PREVIOUS_QUESTION_MANDATORY_TYPE}=2]?gotoCoreSymptom,1)  ; goto core symptom flow
exten => getPreviousQuestion,n,Gotoif($["${PREVIOUS_QUESTION_ID_TEXT}"!="-2"]?previousQuestionExist)
exten => getPreviousQuestion,n,Playback(${LANGUAGE}noMorePreviousQuestionsExist)
exten => getPreviousQuestion,n,Goto(getAnswer,1)
exten => getPreviousQuestion,n(previousQuestionExist),Set(QUESTION_ID=${PREVIOUS_QUESTION_ID})
exten => getPreviousQuestion,n,Set(QUESTION_MANDATORY_TYPE=${PREVIOUS_QUESTION_MANDATORY_TYPE})
exten => getPreviousQuestion,n,Goto(getAnswer,1)

exten => gotoCoreSymptom,1,Set(SYMPTOM_ID=${PREVIOUS_QUESTION_ID})
exten => gotoCoreSymptom,n,Goto(CORE_SYMPTOM,s,getCoreSymptomFileName)

exten => incorrectCredentials,1,Playback(${LANGUAGE}incorrectIdOrPin)  ;Asking caller to try again if incorrectIdOrPin
exten => incorrectCredentials,n,Set(AUTH_TRY_COUNT=$[${AUTH_TRY_COUNT} + 1])
exten => incorrectCredentials,n,Gotoif($["${AUTH_TRY_COUNT}"!="3"]?getCallerId,1)
exten => incorrectCredentials,n,Playback(${LANGUAGE}contactAdmin)
exten => incorrectCredentials,n,Goto(endCall,1)

exten => endCall,1,Playback(${LANGUAGE}thankyou)
exten => endCall,n,Hangup()

exten => ivrsException,1,Playback(${LANGUAGE}technicalIssue)
exten => ivrsException,n,Goto(endCall,1)

[questions](!);This is an abstract extension, can be inherited by other extensions. Its purpose is for reuse.
exten => s,1,Set(REPEAT=0)
exten => s,n(playQuestion),Gotoif($["${QUESTION_FILENAME}" != ""]?playAudioFile)
exten => s,n,Swift(${QUESTION_TEXT})
exten => s,n,Goto(saveAnser)  ; skip play question audio file
exten => s,n(playAudioFile),Playback(${LANGUAGE}${QUESTION_FILENAME})
exten => s,n(saveAnser),Set(ANSWER=${ODBC_GET_ANSWER(${USER_ID,FORM_ID,QUESTION_ID,QUESTION_MANDATORY_TYPE})})
exten => s,n,Gotoif($["${ANSWER}" = ""]?myTest,ivrsException,1)
exten => s,n,Gotoif($[${ANSWER} = -1]?myTest,ivrsException,1)
exten => s,n,GotoIf($["${ANSWER}"="0"]?notAnswered:alreadyAnswered,1)
exten => s,n(notAnswered),Set(ANSWER=0)
exten => s,n,Gosubif($["${QUESTION_TYPE}"="FREQUENCY"]?setFrequencyFlag,1)
exten => s,n,Gosubif($["${QUESTION_TYPE}"="SEVERITY"]?setSeverityFlag,1)
exten => s,n,Gosubif($["${QUESTION_TYPE}"="INTERFERENCE"]?setInterferenceFlag,1)
exten => s,n(notFirstQuestion),Goto(answer,1)
exten => s,n,Hangup()  ; *error condition. It should never get here.*

exten => alreadyAnswered,1,Set(CONFIRMATION_REQ=1)
exten => alreadyAnswered,n,GotoIf($["${QUESTION_TYPE}"="PRESENT"]?playPresentAnswer,1)
exten => alreadyAnswered,n,GotoIf($["${QUESTION_TYPE}"="FREQUENCY"]?playFrequencyAnswer,1)
exten => alreadyAnswered,n,GotoIf($["${QUESTION_TYPE}"="SEVERITY"]?playSeverityAnswer,1)
exten => alreadyAnswered,n,GotoIf($["${QUESTION_TYPE}"="INTERFERENCE"]?playInterferenceAnswer,1)
exten => alreadyAnswered,n,GotoIf($["${QUESTION_TYPE}"="AMOUNT"]?playAmountAnswer,1)

exten => confirmAnswerSubmission,1,GotoIf($["${CONFIRMATION_REQ}"="0"]?noChangeInAnswer)
exten => confirmAnswerSubmission,n,Read(CONFIRM_ANSWER,${LANGUAGE}confirmOrChangeThisAnswerYN,1,,3)
;exten => confirmAnswerSubmission,n,SayDigits(${CONFIRM_ANSWER})
exten => confirmAnswerSubmission,n,GotoIf($["${CONFIRM_ANSWER}"="0"]?noChangeInAnswer)
exten => confirmAnswerSubmission,n,GotoIf($["${CONFIRM_ANSWER}"="7"]?myTest,getPreviousQuestion,1)
exten => confirmAnswerSubmission,n,GotoIf($["${CONFIRM_ANSWER}"="9"]?confirmAnswerSubmission,1)
exten => confirmAnswerSubmission,n,GotoIf($["${CONFIRM_ANSWER}"="1"]?s,notAnswered:invalidConfirmationOption,1)
exten => confirmAnswerSubmission,n(noChangeInAnswer),Goto(finish,submitAnswerGetNewQuestion)

exten => invalidConfirmationOption,1,PlayBack(${LANGUAGE}invalidOption)  ; play the invalid option entered audio
exten => invalidConfirmationOption,n,Goto(confirmAnswerSubmission,1)  ; go back and repeat confiramtion message

exten => playPresentAnswer,1,GotoIf($["${ANSWER}"="0"]?play1:two)
exten => playPresentAnswer,n(play1),Playback(${LANGUAGE}presentOption2)
exten => playPresentAnswer,n(two),GotoIf($["${ANSWER}"="1"]?play2:confirmAnswer)
exten => playPresentAnswer,n(play2),Playback(${LANGUAGE}presentOption1)
exten => playPresentAnswer,n(confirmAnswer),Goto(confirmAnswerSubmission,1)

exten => playFrequencyAnswer,1,GotoIf($["${ANSWER}"="0"]?play1:two)
exten => playFrequencyAnswer,n(play1),Playback(${LANGUAGE}frequencyOption1)
exten => playFrequencyAnswer,n(two),GotoIf($["${ANSWER}"="1"]?play2:three)
exten => playFrequencyAnswer,n(play2),Playback(${LANGUAGE}frequencyOption2)
exten => playFrequencyAnswer,n(three),GotoIf($["${ANSWER}"="2"]?play3:four)
exten => playFrequencyAnswer,n(play3),Playback(${LANGUAGE}frequencyOption3)
exten => playFrequencyAnswer,n(four),GotoIf($["${ANSWER}"="3"]?play4:five)
exten => playFrequencyAnswer,n(play4),Playback(${LANGUAGE}frequencyOption4)
exten => playFrequencyAnswer,n(five),GotoIf($["${ANSWER}"="4"]?play5:confirmAnswer)
exten => playFrequencyAnswer,n(play5),Playback(${LANGUAGE}frequencyOption5)
exten => playFrequencyAnswer,n(confirmAnswer),Goto(confirmAnswerSubmission,1)

exten => playSeverityAnswer,1,GotoIf($["${ANSWER}"="0"]?play1:two)
exten => playSeverityAnswer,n(play1),Playback(${LANGUAGE}severityOption1)
exten => playSeverityAnswer,n(two),GotoIf($["${ANSWER}"="1"]?play2:three)
exten => playSeverityAnswer,n(play2),Playback(${LANGUAGE}severityOption2)
exten => playSeverityAnswer,n(three),GotoIf($["${ANSWER}"="2"]?play3:four)
exten => playSeverityAnswer,n(play3),Playback(${LANGUAGE}severityOption3)
exten => playSeverityAnswer,n(four),GotoIf($["${ANSWER}"="3"]?play4:five)
exten => playSeverityAnswer,n(play4),Playback(${LANGUAGE}severityOption4)
exten => playSeverityAnswer,n(five),GotoIf($["${ANSWER}"="4"]?play5:confirmAnswer)
exten => playSeverityAnswer,n(play5),Playback(${LANGUAGE}severityOption5)
exten => playSeverityAnswer,n(confirmAnswer),Goto(confirmAnswerSubmission,1)

exten => playInterferenceAnswer,1,GotoIf($["${ANSWER}"="0"]?play1:two)
exten => playInterferenceAnswer,n(play1),Playback(${LANGUAGE}interferenceOption1)
exten => playInterferenceAnswer,n(two),GotoIf($["${ANSWER}"="1"]?play2:three)
exten => playInterferenceAnswer,n(play2),Playback(${LANGUAGE}interferenceOption2)
exten => playInterferenceAnswer,n(three),GotoIf($["${ANSWER}"="2"]?play3:four)
exten => playInterferenceAnswer,n(play3),Playback(${LANGUAGE}interferenceOption3)
exten => playInterferenceAnswer,n(four),GotoIf($["${ANSWER}"="3"]?play4:five)
exten => playInterferenceAnswer,n(play4),Playback(${LANGUAGE}interferenceOption4)
exten => playInterferenceAnswer,n(five),GotoIf($["${ANSWER}"="4"]?play5:confirmAnswer)
exten => playInterferenceAnswer,n(play5),Playback(${LANGUAGE}interferenceOption5)
exten => playInterferenceAnswer,n(confirmAnswer),Goto(confirmAnswerSubmission,1)

exten => playAmountAnswer,1,GotoIf($["${ANSWER}"="0"]?play1:two)
exten => playAmountAnswer,n(play1),Playback(${LANGUAGE}amountOption1)
exten => playAmountAnswer,n(two),GotoIf($["${ANSWER}"="1"]?play2:three)
exten => playAmountAnswer,n(play2),Playback(${LANGUAGE}amountOption2)
exten => playAmountAnswer,n(three),GotoIf($["${ANSWER}"="2"]?play3:four)
exten => playAmountAnswer,n(play3),Playback(${LANGUAGE}amountOption3)
exten => playAmountAnswer,n(four),GotoIf($["${ANSWER}"="3"]?play4:five)
exten => playAmountAnswer,n(play4),Playback(${LANGUAGE}amountOption4)
exten => playAmountAnswer,n(five),GotoIf($["${ANSWER}"="4"]?play5:confirmAnswer)
exten => playAmountAnswer,n(play5),Playback(${LANGUAGE}amountOption5)
exten => playAmountAnswer,n(confirmAnswer),Goto(confirmAnswerSubmission,1)

exten => setFrequencyFlag,1,GotoIf($["${FREQUENCY_FLAG}"="1"]?s,notFirstQuestion)
exten => setFrequencyFlag,n,Playback(${LANGUAGE}frequencyOptions)
exten => setFrequencyFlag,n,Read(USER_ANSWER,,1,,)
exten => setFrequencyFlag,n,GotoIf($["${USER_ANSWER}"=""]?t,1)
exten => setFrequencyFlag,n,GotoIf($["${USER_ANSWER}"="9"]?s,playQuestion)
exten => setFrequencyFlag,n,GotoIf($["${USER_ANSWER}"="7"]?myTest,getPreviousQuestion,1)
exten => setFrequencyFlag,n,GotoIf($["${USER_ANSWER}"="0"]?setAnswer)
exten => setFrequencyFlag,n,GotoIf($["${USER_ANSWER}"="1"]?setAnswer)
exten => setFrequencyFlag,n,GotoIf($["${USER_ANSWER}"="2"]?setAnswer)
exten => setFrequencyFlag,n,GotoIf($["${USER_ANSWER}"="3"]?setAnswer)
exten => setFrequencyFlag,n,GotoIf($["${USER_ANSWER}"="4"]?setAnswer)
exten => setFrequencyFlag,n,GotoIf($["${USER_ANSWER}"="*"]?myTest,playInstructions,1)
exten => setFrequencyFlag,n,GotoIf($["${USER_ANSWER}"="5"]?invalidOption,1)
exten => setFrequencyFlag,n,GotoIf($["${USER_ANSWER}"="6"]?invalidOption,1)
exten => setFrequencyFlag,n,GotoIf($["${USER_ANSWER}"="8"]?invalidOption,1)
exten => setFrequencyFlag,n(setAnswer),Set(ANSWER=${USER_ANSWER})
exten => setFrequencyFlag,n,SET(FREQUENCY_FLAG=1)
exten => setFrequencyFlag,n,Goto(finish,1)

exten => setSeverityFlag,1,GotoIf($["${SEVERITY_FLAG}"="1"]?s,notFirstQuestion)
exten => setSeverityFlag,n,Playback(${LANGUAGE}severityOptions)
exten => setSeverityFlag,n,Read(USER_ANSWER,,1,,)
exten => setSeverityFlag,n,GotoIf($["${USER_ANSWER}"=""]?t,1)
exten => setSeverityFlag,n,GotoIf($["${USER_ANSWER}"="9"]?s,playQuestion)
exten => setSeverityFlag,n,GotoIf($["${USER_ANSWER}"="7"]?myTest,getPreviousQuestion,1)
exten => setSeverityFlag,n,GotoIf($["${USER_ANSWER}"="0"]?setAnswer)
exten => setSeverityFlag,n,GotoIf($["${USER_ANSWER}"="1"]?setAnswer)
exten => setSeverityFlag,n,GotoIf($["${USER_ANSWER}"="2"]?setAnswer)
exten => setSeverityFlag,n,GotoIf($["${USER_ANSWER}"="3"]?setAnswer)
exten => setSeverityFlag,n,GotoIf($["${USER_ANSWER}"="4"]?setAnswer)
exten => setSeverityFlag,n,GotoIf($["${USER_ANSWER}"="*"]?myTest,playInstructions,1)
exten => setSeverityFlag,n,GotoIf($["${USER_ANSWER}"="5"]?invalidOption,1)
exten => setSeverityFlag,n,GotoIf($["${USER_ANSWER}"="6"]?invalidOption,1)
exten => setSeverityFlag,n,GotoIf($["${USER_ANSWER}"="8"]?invalidOption,1)
exten => setSeverityFlag,n(setAnswer),Set(ANSWER=${USER_ANSWER})
exten => setSeverityFlag,n,SET(SEVERITY_FLAG=1)
exten => setSeverityFlag,n,Goto(finish,1)

exten => setInterferenceFlag,1,GotoIf($["${INTERFERENCE_FLAG}"="1"]?s,notFirstQuestion)
exten => setInterferenceFlag,n,Playback(${LANGUAGE}interferenceOptions)
exten => setInterferenceFlag,n,Read(USER_ANSWER,,1,,)
exten => setInterferenceFlag,n,GotoIf($["${USER_ANSWER}"=""]?t,1)
exten => setInterferenceFlag,n,GotoIf($["${USER_ANSWER}"="9"]?s,playQuestion)
exten => setInterferenceFlag,n,GotoIf($["${USER_ANSWER}"="7"]?myTest,getPreviousQuestion,1)
exten => setInterferenceFlag,n,GotoIf($["${USER_ANSWER}"="0"]?setAnswer)
exten => setInterferenceFlag,n,GotoIf($["${USER_ANSWER}"="1"]?setAnswer)
exten => setInterferenceFlag,n,GotoIf($["${USER_ANSWER}"="2"]?setAnswer)
exten => setInterferenceFlag,n,GotoIf($["${USER_ANSWER}"="3"]?setAnswer)
exten => setInterferenceFlag,n,GotoIf($["${USER_ANSWER}"="4"]?setAnswer)
exten => setInterferenceFlag,n,GotoIf($["${USER_ANSWER}"="*"]?myTest,playInstructions,1)
exten => setInterferenceFlag,n,GotoIf($["${USER_ANSWER}"="5"]?invalidOption,1)
exten => setInterferenceFlag,n,GotoIf($["${USER_ANSWER}"="6"]?invalidOption,1)
exten => setInterferenceFlag,n,GotoIf($["${USER_ANSWER}"="8"]?invalidOption,1)
exten => setInterferenceFlag,n(setAnswer),Set(ANSWER=${USER_ANSWER})
exten => setInterferenceFlag,n,SET(INTERFERENCE_FLAG=1)
exten => setInterferenceFlag,n,Goto(finish,1)

exten => invalidOption,1,Playback(${LANGUAGE}invalidOption)  ; "That's not valid, try again"
exten => invalidOption,n,Goto(s,playQuestion)

;exten => finish,1,GotoIf($["${FORM_SUBMISSION}"="1"]?saydigit)
;exten => finish,n,Set(CONFIRMATION_REQ=0)
;exten => finish,n,Goto(alreadyAnswered,1)
;exten => finish,n(saydigit),SayDigits(${ANSWER})
;exten => finish,n,Set(FORM_SUBMISSION=0)
;exten => finish,n(submitAnswerGetNewQuestion),Set(QUESTION_ID=$[${ODBC_ANSWER_QUESTION(${USER_ID,FORM_ID,QUESTION_ID,ANSWER,QUESTION_MANDATORY_TYPE})}])  ;record answer in db and get next question
;exten => finish,n,Gotoif($["${QUESTION_ID}" = ""]?myTest,ivrsException,1)
;exten => finish,n,Gotoif($[${QUESTION_ID} = -1]?myTest,ivrsException,1)
;exten => finish,n,Goto(myTest,getAnswer,1)
;exten => finish,n,Hangup()         ; *error condition. It should never get here.*

exten => finish,1(submitAnswerGetNewQuestion),Set(QUESTION_ID_TEXT=$[${ODBC_ANSWER_QUESTION(${USER_ID,FORM_ID,QUESTION_ID,ANSWER,QUESTION_MANDATORY_TYPE})}])  ;record answer in db and get next question
exten => finish,n,Gotoif($["${QUESTION_ID_TEXT}" = ""]?myTest,ivrsException,1)
exten => finish,n,Gotoif($[${QUESTION_ID_TEXT} = -1]?myTest,ivrsException,1)
exten => finish,n,Set(QUESTION_ID=${CUT(QUESTION_ID_TEXT,_,1)})
exten => finish,n,Set(QUESTION_MANDATORY_TYPE_TEMP=${CUT(QUESTION_ID_TEXT,_,2)})
exten => finish,n,Set(QUESTION_MANDATORY_TYPE=${IF($[ "${QUESTION_MANDATORY_TYPE_TEMP}" != ""]?${QUESTION_MANDATORY_TYPE_TEMP}:${QUESTION_MANDATORY_TYPE})})
exten => finish,n,Goto(myTest,getAnswer,1)
exten => finish,n,Hangup()  ; *error condition. It should never get here.*


exten => t,1,Set(REPEAT= $[${REPEAT} + 1])
exten => t,n,Playback(${LANGUAGE}sorryCouldNotHear)
exten => t,n,Gotoif($[${REPEAT}<3]?s,playQuestion:abort)
exten => t,n(abort),NoOp("add DB abort here.")  ;
exten => t,n,Playback(${LANGUAGE}tryLater)
exten => t,n,Goto(myTest,endCall,1)

exten => i,1,Playback(${LANGUAGE}invalidOption)  ; "That's not valid, try again"
exten => i,n,Goto(s,playQuestion)

[PRESENTQUESTION](questions)
exten => answer,1,Background(${LANGUAGE}presentOptions)
exten => answer,n,WaitExten

exten => 0,1,Set(ANSWER=0)  ;no
exten => 0,n,Goto(finish,1)

exten => 1,1,Set(ANSWER=1)  ;yes
exten => 1,n,Goto(finish,1)

exten => 7,1,Set(ANSWER=0)  ;no
exten => 7,n,Goto(myTest,getPreviousQuestion,1)

exten => 9,1,Set(ANSWER=0)
exten => 9,n,Goto(s,playQuestion)

exten => *,1,Set(ANSWER=0)
exten => *,n,Goto(myTest,playInstructions,1)

[FREQUENCYQUESTION](questions)
exten => answer,1,Background(${LANGUAGE}frequencyOptions)
exten => answer,n,WaitExten

exten => 0,1,Set(ANSWER=0)  ;never
exten => 0,n,Goto(finish,1)

exten => 1,1,Set(ANSWER=1)  ;rarely
exten => 1,n,Goto(finish,1)

exten => 2,1,Set(ANSWER=2)  ;occationally
exten => 2,n,Goto(finish,1)

exten => 3,1,Set(ANSWER=3)  ;frequently
exten => 3,n,Goto(finish,1)

exten => 4,1,Set(ANSWER=4)  ;almost constantly
exten => 4,n,Goto(finish,1)

exten => 7,1,Set(ANSWER=0)  ;no
exten => 7,n,Goto(myTest,getPreviousQuestion,1)

exten => 9,1,Set(ANSWER=0)
exten => 9,n,Goto(s,playQuestion)

exten => *,1,Set(ANSWER=0)
exten => *,n,Goto(myTest,playInstructions,1)

[SEVERITYQUESTION](questions)
exten => answer,1,Background(${LANGUAGE}severityOptions)
exten => answer,n,WaitExten

exten => 0,1,Set(ANSWER=0)  ;none
exten => 0,n,Goto(finish,1)

exten => 1,1,Set(ANSWER=1)  ;mild
exten => 1,n,Goto(finish,1)

exten => 2,1,Set(ANSWER=2)  ;moderate
exten => 2,n,Goto(finish,1)

exten => 3,1,Set(ANSWER=3)  ;severe
exten => 3,n,Goto(finish,1)

exten => 4,1,Set(ANSWER=4)  ;very severe
exten => 4,n,Goto(finish,1)

exten => 7,1,Set(ANSWER=0)  ;no
exten => 7,n,Goto(myTest,getPreviousQuestion,1)

exten => 9,1,Set(ANSWER=0)
exten => 9,n,Goto(s,playQuestion)

exten => *,1,Set(ANSWER=0)
exten => *,n,Goto(myTest,playInstructions,1)

[INTERFERENCEQUESTION](questions)
exten => answer,1,Background(${LANGUAGE}interferenceOptions)
exten => answer,n,WaitExten

exten => 0,1,Set(ANSWER=0)  ;not at all
exten => 0,n,Goto(finish,1)

exten => 1,1,Set(ANSWER=1)  ;a little bit
exten => 1,n,Goto(finish,1)

exten => 2,1,Set(ANSWER=2)  ;somewhat
exten => 2,n,Goto(finish,1)

exten => 3,1,Set(ANSWER=3)  ;quite a bit
exten => 3,n,Goto(finish,1)

exten => 4,1,Set(ANSWER=4)  ;very much
exten => 4,n,Goto(finish,1)

exten => 7,1,Set(ANSWER=0)  ;no
exten => 7,n,Goto(myTest,getPreviousQuestion,1)

exten => 9,1,Set(ANSWER=0)
exten => 9,n,Goto(s,playQuestion)

exten => *,1,Set(ANSWER=0)
exten => *,n,Goto(myTest,playInstructions,1)

[AMOUNTQUESTION](questions)
exten => answer,1,Background(${LANGUAGE}amountOptions)
exten => answer,n,WaitExten

exten => 0,1,Set(ANSWER=0)  ;none
exten => 0,n,Goto(finish,1)

exten => 1,1,Set(ANSWER=1)  ;mild
exten => 1,n,Goto(finish,1)

exten => 2,1,Set(ANSWER=2)  ;moderate
exten => 2,n,Goto(finish,1)

exten => 3,1,Set(ANSWER=3)  ;severe
exten => 3,n,Goto(finish,1)

exten => 4,1,Set(ANSWER=4)  ;very severe
exten => 4,n,Goto(finish,1)

exten => 7,1,Set(ANSWER=0)  ;no
exten => 7,n,Goto(myTest,getPreviousQuestion,1)

exten => 9,1,Set(ANSWER=0)
exten => 9,n,Goto(s,playQuestion)

exten => *,1,Set(ANSWER=0)
exten => *,n,Goto(myTest,playInstructions,1)

[SUBMITFORM]
exten => s,1,Set(REPEAT=0)
exten => s,n(promptRecording),Background(${LANGUAGE}recordAdditionalSymptomInstructions) ; press 1 to record, 2 to skip recording
exten => s,n,WaitExten

exten => 1,1,Goto(Record-Symptom,1,1) ; yes

exten => 0,1,Goto(finish,1) ; No

exten => 7,1,Goto(myTest,getPreviousQuestion,1)  ; go to previous question

exten => 9,1,Goto(s,promptRecording)

exten => t,1,Set(REPEAT= $[${REPEAT} + 1])
exten => t,n,Gotoif($[${REPEAT}<3]?s,promptRecording:abort)
exten => t,n(abort),NoOp("add DB abort here.")  ;
exten => t,n,Playback(${LANGUAGE}sorryCouldNotHear)
exten => t,n,Playback(${LANGUAGE}tryLater)
exten => t,n,Goto(myTest,endCall,1)

exten => i,1,Playback(${LANGUAGE}invalidOption)  ; "That's not valid, try again"
exten => i,n,Goto(s,promptRecording)

exten => finish,1,Set(ABC=${ODBC_COMMITSESSION(${USER_ID,FORM_ID,INPUT_CALLER_PIN})})
exten => finish,n,Gotoif($["${ABC}" = ""]?myTest,ivrsException,1)
exten => finish,n,Gotoif($[${ABC} = -1]?myTest,ivrsException,1)
exten => finish,n,Playback(${LANGUAGE}successfullySubmittedForm)
exten => finish,n(noSubmission),Goto(myTest,endCall,1)


[Record-Symptom]
exten => 1,1,Playback(${LANGUAGE}recordingInstructions)
exten => 1,n,Set(FILE_NAME_FORMAT=${USER_ID}_${FORM_ID}_${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)})
exten => 1,n,Set(RECORDED_FILENAME=${RECORDED_FILE_LOCATION}${FILE_NAME_FORMAT})
exten => 1,n,Record(${RECORDED_FILENAME}:gsm,0,10)
;exten => 1,n,Playback(${RECORDED_FILENAME})
exten => 1,n,Set(RECORDED_FILENAME='${RECORDED_FILENAME}')
exten => 1,n,Set(RETURN_VALUE=${ODBC_SAVE_RECORDED_FILENAME(${USER_ID,FORM_ID,RECORDED_FILENAME})})
exten => 1,n,Gotoif($["${RETURN_VALUE}" = ""]?myTest,ivrsException,1)
exten => 1,n,Gotoif($[${RETURN_VALUE} = -1]?myTest,ivrsException,1)
exten => 1,n,Goto(SUBMITFORM,finish,1)

[CORE_SYMPTOM]
;play instruction message for core symptom
exten => s,1,Set(CORE_SYMPTOM_FLAG=1)
exten => s,n,Set(REPEAT=0)
exten => s,n,Set(SYMPTOM_ID=${ODBC_GET_CORE_SYMPTOM_ID(${USER_ID,FORM_ID,INPUT_CALLER_PIN})})  ; get the core symptom name
exten => s,n,Gotoif($["${SYMPTOM_ID}" = ""]?myTest,ivrsException,1)
exten => s,n,Gotoif($[${SYMPTOM_ID} = -1]?myTest,ivrsException,1)
exten => s,n,Gotoif($[${SYMPTOM_ID} = 0]?myTest,getFirstQuestion,1)
exten => s,n,Set(PREVIOUS_SYMPTOM_INDICATOR=0)
exten => s,n(getCoreSymptomFileName),Set(CORE_SYMPTOM_FILE_NAME=${ODBC_GET_CORE_SYMPTOM_FILENAME(${USER_ID,FORM_ID,SYMPTOM_ID})}) ;get the core symptom name
exten => s,n,Gotoif($["${CORE_SYMPTOM_FILE_NAME}" = ""]?myTest,ivrsException,1)
exten => s,n,Gotoif($[${CORE_SYMPTOM_FILE_NAME} = -1]?myTest,ivrsException,1)
exten => s,n,Set(CORE_SYMPTOM_FLAG=1)
exten => s,n,Set(REPEAT=0)
exten => s,n,Goto(answer,1)

exten => getPreviousSymptom,1,Set(PREVIOUS_SYMPTOM_ID_TEXT=${ODBC_GET_PREVIOUS_SYMOPTOM(${USER_ID,FORM_ID,SYMPTOM_ID})})
exten => getPreviousSymptom,n,Gotoif($["${PREVIOUS_SYMPTOM_ID_TEXT}" = ""]?ivrsException,1)
exten => getPreviousSymptom,n,Gotoif($[${PREVIOUS_SYMPTOM_ID_TEXT} = -1]?ivrsException,1)
exten => getPreviousSymptom,n,Set(PREVIOUS_SYMPTOM_ID=${CUT(PREVIOUS_SYMPTOM_ID_TEXT,_,1)})
exten => getPreviousSymptom,n,Set(PREVIOUS_SYMPTOM_TYPE=${CUT(PREVIOUS_SYMPTOM_ID_TEXT,_,2)})
exten => getPreviousSymptom,n,Gotoif($[${PREVIOUS_SYMPTOM_TYPE} = 2]?previousSymptomExist:previousQuestionExistFromCore)  ;play the
exten => getPreviousSymptom,n(previousSymptomExist),Set(SYMPTOM_ID=${PREVIOUS_SYMPTOM_ID})
exten => getPreviousSymptom,n,Set(SYMPTOM_MANDATORY_TYPE=${PREVIOUS_SYMPTOM_TYPE})
exten => getPreviousSymptom,n,Set(PREVIOUS_SYMPTOM_INDICATOR=1)
exten => getPreviousSymptom,n,Goto(s,getCoreSymptomFileName)
exten => getPreviousSymptom,n(previousQuestionExistFromCore),Set(QUESTION_ID=${PREVIOUS_SYMPTOM_ID})
exten => getPreviousSymptom,n,Set(QUESTION_MANDATORY_TYPE=${PREVIOUS_SYMPTOM_TYPE})
exten => getPreviousSymptom,n,Set(CORE_SYMPTOM_FLAG=0)
exten => getPreviousSymptom,n,Goto(myTest,getAnswer,1)

exten => playSymptomAnswer,1,GotoIf($["${SYMPTOM_ANSWER}"="1"]?play1:two)
exten => playSymptomAnswer,n(play1),Playback(${LANGUAGE}presentOption2)
exten => playSymptomAnswer,n(two),GotoIf($["${SYMPTOM_ANSWER}"="2"]?play2:confirmAnswer)
exten => playSymptomAnswer,n(play2),Playback(${LANGUAGE}presentOption1)
exten => playSymptomAnswer,n(confirmAnswer),Goto(confirmSymptomAnswerSubmission,1)

exten => confirmSymptomAnswerSubmission,1,Read(CONFIRM_ANSWER,${LANGUAGE}confirmOrChangeThisAnswerYN,1,,3)
exten => confirmSymptomAnswerSubmission,n,GotoIf($["${CONFIRM_ANSWER}"="0"]?noChangeInAnswer)
exten => confirmSymptomAnswerSubmission,n,GotoIf($["${CONFIRM_ANSWER}"="7"]?getPreviousSymptom,1)
exten => confirmSymptomAnswerSubmission,n,GotoIf($["${CONFIRM_ANSWER}"="9"]?confirmSymptomAnswerSubmission,1)
exten => confirmSymptomAnswerSubmission,n,GotoIf($["${CONFIRM_ANSWER}"="1"]?answer,notAnswered:invalidConfirmationOption,1)
exten => confirmSymptomAnswerSubmission,n(noChangeInAnswer),Set(RESPONSE=${SYMPTOM_ANSWER})
exten => confirmSymptomAnswerSubmission,n,Set(SYMPTOM_ID=${ODBC_ANSWER_CORE_SYMPTOM(${USER_ID,FORM_ID,SYMPTOM_ID,RESPONSE,PREVIOUS_SYMPTOM_INDICATOR})})
exten => confirmSymptomAnswerSubmission,n,Set(PREVIOUS_SYMPTOM_INDICATOR=0)
exten => confirmSymptomAnswerSubmission,n,Goto(s,getCoreSymptomFileName)

exten => playInstructions,1,Playback(${LANGUAGE}instructions)  ; play Instructions
exten => playInstructions,n,Gotoif($["${SYMPTOM_ID}" != ""]?answer,1)
exten => playInstructions,n,Goto(s,1)  ; go to form fill control

exten => invalidConfirmationOption,1,PlayBack(${LANGUAGE}invalidOption)  ; play the invalid option entered audio
exten => invalidConfirmationOption,n,Goto(confirmSymptomAnswerSubmission,1)  ; go back and repeat confiramtion message

exten => answer,1,Gosubif($[${FORM_HALF_COMPLETED}!=0]?myTest,playHalfWayDone,1)
exten => answer,n,Gosubif($[$[${QUESTION_COUNTER}%${RECALL_PERIOD_MODULUS_VALUE}] = 0]?myTest,playRecallPeriod,1)
exten => answer,n,Set(QUESTION_COUNTER= $[${QUESTION_COUNTER} + 1])
exten => answer,n,Playback(${LANGUAGE}${CORE_SYMPTOM_FILE_NAME})
exten => answer,n,Set(SYMPTOM_ANSWER=${ODBC_GET_CORE_SYMPTOM_ANSWER(${USER_ID,FORM_ID,SYMPTOM_ID,PREVIOUS_SYMPTOM_INDICATOR})})
exten => answer,n,Gotoif($["${SYMPTOM_ANSWER}" = ""]?myTest,ivrsException,1)
exten => answer,n,Gotoif($[${SYMPTOM_ANSWER} = -1]?myTest,ivrsException,1)
exten => answer,n,GotoIf($[${SYMPTOM_ANSWER}=0]?notAnswered:playSymptomAnswer,1)
exten => answer,n(notAnswered),Background(${LANGUAGE}presentOptions)
exten => answer,n,WaitExten(5)

exten => 1,1,Set(RESPONSE=1)  ;Yes, submit the response to DB
exten => 1,n,Set(QUESTION_MANDATORY_TYPE=2)
exten => 1,n,Set(SYMPTOM_ID=${ODBC_ANSWER_CORE_SYMPTOM(${USER_ID,FORM_ID,SYMPTOM_ID,RESPONSE,PREVIOUS_SYMPTOM_INDICATOR})})  ; call the DB function to send the core sympotm response
exten => 1,n,Set(PREVIOUS_SYMPTOM_INDICATOR=0)
exten => 1,n,Gotoif($["${SYMPTOM_ID}" = ""]?myTest,ivrsException,1)
exten => 1,n,Gotoif($[${SYMPTOM_ID} = -1]?myTest,ivrsException,1)
exten => 1,n,Gotoif($[${SYMPTOM_ID} = 0]?myTest,getFirstQuestion,1)
exten => 1,n,Goto(s,getCoreSymptomFileName)  ; go to next core symptom

exten => 0,1,Set(RESPONSE=2)  ;No, go to next symptom
exten => 0,n,Set(QUESTION_MANDATORY_TYPE=2)
exten => 0,n,Set(SYMPTOM_ID=${ODBC_ANSWER_CORE_SYMPTOM(${USER_ID,FORM_ID,SYMPTOM_ID,RESPONSE,PREVIOUS_SYMPTOM_INDICATOR})})
exten => 0,n,Set(PREVIOUS_SYMPTOM_INDICATOR=0)
exten => 0,n,Gotoif($["${SYMPTOM_ID}" = ""]?myTest,ivrsException,1)
exten => 0,n,Gotoif($[${SYMPTOM_ID} = -1]?myTest,ivrsException,1)
exten => 0,n,Gotoif($[${SYMPTOM_ID} = 0]?myTest,getFirstQuestion,1)
exten => 0,n,Goto(s,getCoreSymptomFileName)

exten => 9,1,Goto(answer,1)

exten => 7,1,Goto(getPreviousSymptom,1)

exten => *,1,Goto(playInstructions,1)

exten => i,1,Playback(${LANGUAGE}invalidOption)  ; "That's not valid option, try again"
exten => i,n,Goto(answer,1)

exten => t,1,Set(REPEAT= $[${REPEAT} + 1])
exten => t,n,Gotoif($[${REPEAT}<3]?answer,1:abort)
exten => t,n(abort),NoOp("add DB abort here.")  ;
exten => t,n,Playback(${LANGUAGE}sorryCouldNotHear)
exten => t,n,Playback(${LANGUAGE}tryLater)
exten => t,n,Goto(myTest,endCall,1)