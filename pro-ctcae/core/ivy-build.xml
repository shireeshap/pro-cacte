<project name="ctcae-core" default="compile" xmlns:ivy="antlib:org.apache.ivy.ant">
    <property name="parent.dir" value="${basedir}/.."/>
    <property file="${parent.dir}/build.properties"/>
    <import file="${parent.dir}/common.xml"/>

    <target name="module-specific-flow" depends="resolve">
        <mkdir dir="${classes.dir}/db"/>
        <copy-resources src="${main.src}/../db" dest="${classes.dir}/db" filter="true"/>
    </target>


    <!-- ========================================================================
             target : jar-test
                 Will call aspectj-compile of test classes then delegates to common jar-test
         ============================================================================-->
    <target name="jar-test" depends="common.jar-test">
        <!--<makeJar dir="${dist.dir}" dir.classes="${test.classes.dir}" file.name="${test.jar.file}"/> -->
    </target>


    <!-- ========================================================================
              target: migrate
               Will run the bering migration ..
          ============================================================================= -->
    <target name="migrate" description="does bering migration" depends="resolve,find-datasource">
        <echo message="Datasource File : ${dsFile}"/>
        <property file="${dsFile}"/>
        <taskdef resource="edu/northwestern/bioinformatics/bering/antlib.xml" classpathref="main.classpath"/>
        <property name="migrate.version" value=""/>
        <property name="bering.dialect" value=""/>
        <migrate classpathRef="main.classpath"
                 driver="${datasource.driver}"
                 dialect="${bering.dialect}"
                 url="${datasource.url}"
                 userid="${datasource.username}"
                 password="${datasource.password}"
                 targetVersion="${migrate.version}"
                 migrationsdir="${main.src}/../db/migrate"/>
        <echo message="migrate.version : ${migrate.version}"/>
        <echo message="bering.dialect : ${bering.dialect}"/>
    </target>

    <!-- ========================================================================
       target: migrate
        Will run the bering migration ..
   ============================================================================= -->

    <target name="migrate-sample-data" description="add sample data" depends="find-datasource">
        <taskdef name="dbunit" classname="org.dbunit.ant.DbUnitTask" classpathref="main.classpath"/>
        <property file="${dsFile}"/>
        <echo>add sample data into ${datasource.url}</echo>
        <dbunit classpathRef="main.classpath"
                driver="${datasource.driver}"
                url="${datasource.url}"
                userid="${datasource.username}"
                password="${datasource.password}">
            <operation type="INSERT"
                       src="src/test/resources/gov/nih/nci/ctcae/core/sampledata/Sample_Data.xml"/>
        </dbunit>
    </target>


    <!-- ========================================================================
            target: find-admin-datasource
                Will check the datsource properties identified by -Ddb=xxx, in USER_HOME/.ctcae/
                if not available there, it will search in /etc/ctcae/
        ============================================================================= -->
    <target name="find-admin-datasource" unless="adminDsFile.loaded"
            description="Loads the admin datasource properties">
        <echo message="databaseConfigurationName : ${databaseConfigurationName}-admin"/>
        <condition property="adminDsFile" value="${user.home}/.ctcae/${databaseConfigurationName}-admin.properties"
                   else="/etc/ctcae/${databaseConfigurationName}-admin.properties">
            <available file="${user.home}/.ctcae/${databaseConfigurationName}-admin.properties"/>
        </condition>
        <property name="adminDsFile.loaded" value="true"/>
    </target>
    <!-- ===============================================================================================
              target : recreate-db-hudson
           ================================================================================================= -->
    <target name="recreate-db-hudson" description="drop the database and create new database"
            depends="resolve, find-admin-datasource">
        <property file="${adminDsFile}"/>
        <echo message="${datasource.driver}"/>
        <echo message="${datasource.url}"/>
        <echo message="${datasource.username}"/>
        <echo message="${datasource.password}"/>
        <sql driver="${datasource.driver}" userid="${datasource.username}" password="${datasource.password}"
             url="${datasource.url}"
             classpathref="main.classpath" onerror="abort" autocommit="true">
            DROP DATABASE IF EXISTS "${database.name}";
            CREATE DATABASE "${database.name}";
        </sql>
    </target>


</project>
